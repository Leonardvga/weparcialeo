<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Exámenes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .question-container {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .options-container {
            margin-top: 10px;
        }
        .option-item {
            margin-bottom: 8px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .link-box {
            background-color: #e9f7ef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            display: none;
        }
        .response-container {
            margin-top: 20px;
            display: none;
        }
        .response-item {
            background-color: #f1f8e9;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 4px 4px 0 0;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            margin: 0;
            transition: 0.3s;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #4CAF50;
            color: white;
        }
        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }
        .exam-only-mode {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4CAF50;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <p>Cargando...</p>
    </div>

    <div id="full-app" class="container">
        <h1>Creador de Exámenes</h1>
        
        <div class="tab">
            <button class="tablinks active" onclick="openTab(event, 'crear')">Crear Examen</button>
            <button class="tablinks" onclick="openTab(event, 'responder')">Responder Examen</button>
            <button class="tablinks" onclick="openTab(event, 'resultados')">Ver Resultados</button>
        </div>
        
        <!-- Pestaña de Creación de Examen -->
        <div id="crear" class="tabcontent" style="display: block;">
            <h2>Crear Nuevo Examen</h2>
            <div>
                <label for="exam-title">Título del Examen:</label>
                <input type="text" id="exam-title" placeholder="Ej: Examen Parcial de Matemáticas">
            </div>
            
            <div id="questions-container">
                <!-- Aquí se añadirán las preguntas -->
            </div>
            
            <button onclick="addQuestion()">Añadir Pregunta</button>
            <button onclick="generateExam()">Guardar Examen</button>
            
            <div id="exam-link" class="link-box">
                <p>Enlace para compartir:</p>
                <input type="text" id="share-link" readonly>
                <button onclick="copyLink()">Copiar Enlace</button>
                <button onclick="openExamOnly()">Abrir Examen</button>
            </div>
        </div>
        
        <!-- Pestaña de Responder Examen -->
        <div id="responder" class="tabcontent">
            <h2>Responder Examen</h2>
            <div id="exam-info">
                <p>Ingresa el código o enlace del examen para comenzar:</p>
                <input type="text" id="exam-code" placeholder="Código del examen">
                <button onclick="loadExam()">Cargar Examen</button>
            </div>
            
            <div id="exam-content" style="display: none;">
                <h3 id="exam-title-display"></h3>
                <div id="exam-questions">
                    <!-- Aquí se mostrarán las preguntas del examen -->
                </div>
                <button onclick="submitAnswers()">Enviar Respuestas</button>
            </div>
        </div>
        
        <!-- Pestaña de Resultados -->
        <div id="resultados" class="tabcontent">
            <h2>Resultados del Examen</h2>
            <div>
                <p>Ingresa el código del examen para ver los resultados:</p>
                <input type="text" id="results-code" placeholder="Código del examen">
                <button onclick="loadResults()">Cargar Resultados</button>
            </div>
            
            <div id="results-container" class="response-container">
                <h3>Respuestas recibidas:</h3>
                <div id="responses-list">
                    <!-- Aquí se mostrarán las respuestas -->
                </div>
            </div>
        </div>
    </div>

    <!-- Vista de solo examen (inicialmente oculta) -->
    <div id="exam-only-view" class="exam-only-mode" style="display: none;">
        <h2 id="exam-only-title"></h2>
        <div id="exam-only-questions">
            <!-- Aquí se mostrarán las preguntas en modo solo examen -->
        </div>
        <button onclick="submitAnswersExamOnly()">Enviar Respuestas</button>
    </div>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <!-- Add Firebase products that you want to use -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-firestore-compat.min.js"></script>

    <script>
        // Configuración de Firebase - REEMPLAZA ESTO CON TU CONFIGURACIÓN
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "tu-proyecto.firebaseapp.com",
            projectId: "tu-proyecto",
            storageBucket: "tu-proyecto.appspot.com",
            messagingSenderId: "TU_SENDER_ID",
            appId: "TU_APP_ID"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Obtener una referencia a Firestore
        const db = firebase.firestore();
        
        // Variables globales
        let questions = [];
        let examId = '';
        
        // Función para mostrar/ocultar el indicador de carga
        function toggleLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }
        
        // Función para abrir pestañas
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }
        
        // Función para añadir una pregunta
        function addQuestion() {
            const questionId = 'q' + Date.now();
            const questionContainer = document.getElementById('questions-container');
            
            const questionHTML = `
                <div class="question-container" id="${questionId}">
                    <label>Pregunta:</label>
                    <textarea class="question-text" placeholder="Escribe la pregunta aquí"></textarea>
                    
                    <div class="options-container">
                        <label>Tipo de Respuesta:</label>
                        <select class="question-type" onchange="updateQuestionType('${questionId}', this.value)">
                            <option value="text">Texto</option>
                            <option value="multiple">Opción Múltiple</option>
                        </select>
                        
                        <div class="text-answer" style="margin-top: 10px;">
                            <label>Respuesta Correcta (opcional):</label>
                            <input type="text" class="correct-answer" placeholder="Respuesta correcta">
                        </div>
                        
                        <div class="multiple-options" style="display: none; margin-top: 10px;">
                            <div class="options-list">
                                <!-- Opciones se añadirán aquí -->
                            </div>
                            <button onclick="addOption('${questionId}')" type="button">Añadir Opción</button>
                        </div>
                    </div>
                    
                    <button onclick="removeQuestion('${questionId}')" type="button" style="background-color: #f44336;">Eliminar</button>
                </div>
            `;
            
            questionContainer.insertAdjacentHTML('beforeend', questionHTML);
        }
        
        // Actualizar tipo de pregunta
        function updateQuestionType(questionId, type) {
            const container = document.getElementById(questionId);
            const textAnswer = container.querySelector('.text-answer');
            const multipleOptions = container.querySelector('.multiple-options');
            
            if (type === 'text') {
                textAnswer.style.display = 'block';
                multipleOptions.style.display = 'none';
            } else {
                textAnswer.style.display = 'none';
                multipleOptions.style.display = 'block';
                
                // Si no hay opciones, añadir algunas por defecto
                const optionsList = container.querySelector('.options-list');
                if (optionsList.children.length === 0) {
                    addOption(questionId);
                    addOption(questionId);
                }
            }
        }
        
        // Añadir opción a pregunta múltiple
        function addOption(questionId) {
            const container = document.getElementById(questionId);
            const optionsList = container.querySelector('.options-list');
            const optionId = 'opt' + Date.now();
            
            const optionHTML = `
                <div class="option-item" id="${optionId}">
                    <input type="radio" name="correct-${questionId}" value="${optionId}">
                    <input type="text" placeholder="Opción de respuesta" class="option-text">
                    <button onclick="removeOption('${optionId}')" type="button" style="background-color: #f44336; padding: 5px 10px; margin-left: 5px;">X</button>
                </div>
            `;
            
            optionsList.insertAdjacentHTML('beforeend', optionHTML);
        }
        
        // Eliminar opción
        function removeOption(optionId) {
            document.getElementById(optionId).remove();
        }
        
        // Eliminar pregunta
        function removeQuestion(questionId) {
            document.getElementById(questionId).remove();
        }
        
        // Generar examen
        function generateExam() {
            const title = document.getElementById('exam-title').value;
            if (!title) {
                alert('Por favor, añade un título al examen');
                return;
            }
            
            const questionContainers = document.querySelectorAll('.question-container');
            if (questionContainers.length === 0) {
                alert('Añade al menos una pregunta al examen');
                return;
            }
            
            questions = [];
            questionContainers.forEach(container => {
                const questionText = container.querySelector('.question-text').value;
                const questionType = container.querySelector('.question-type').value;
                let correctAnswer = '';
                let options = [];
                
                if (questionType === 'text') {
                    correctAnswer = container.querySelector('.correct-answer').value;
                } else {
                    const optionItems = container.querySelectorAll('.option-item');
                    optionItems.forEach(item => {
                        const optionText = item.querySelector('.option-text').value;
                        const isCorrect = item.querySelector('input[type="radio"]').checked;
                        
                        options.push({
                            text: optionText,
                            isCorrect: isCorrect
                        });
                        
                        if (isCorrect) {
                            correctAnswer = optionText;
                        }
                    });
                }
                
                questions.push({
                    text: questionText,
                    type: questionType,
                    options: options,
                    correctAnswer: correctAnswer
                });
            });
            
            // Generar un ID único para el examen
            examId = 'EXAM-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            
            const exam = {
                id: examId,
                title: title,
                questions: questions,
                responses: [],
                createdAt: new Date().toISOString()
            };
            
            // Mostrar el indicador de carga
            toggleLoading(true);
            
            // Guardar el examen en Firestore
            db.collection('exams').doc(examId).set(exam)
                .then(() => {
                    // Ocultar el indicador de carga
                    toggleLoading(false);
                    
                    // Mostrar el enlace para compartir
                    const shareLink = window.location.href.split('?')[0] + '?exam=' + examId + '&mode=only';
                    document.getElementById('share-link').value = shareLink;
                    document.getElementById('exam-link').style.display = 'block';
                    
                    alert('Examen guardado correctamente. ID: ' + examId);
                })
                .catch((error) => {
                    toggleLoading(false);
                    console.error("Error al guardar el examen: ", error);
                    alert('Error al guardar el examen: ' + error.message);
                });
        }
        
        // Copiar enlace al portapapeles
        function copyLink() {
            const linkInput = document.getElementById('share-link');
            linkInput.select();
            document.execCommand('copy');
            alert('Enlace copiado al portapapeles');
        }
        
        // Abrir examen en modo solo examen
        function openExamOnly() {
            const shareLink = document.getElementById('share-link').value;
            window.open(shareLink, '_blank');
        }
        
        // Cargar examen para responder
        function loadExam() {
            const codeInput = document.getElementById('exam-code').value;
            const examCode = codeInput.includes('exam=') ? 
                             codeInput.split('exam=')[1].split('&')[0] :
                             codeInput;
            
            if (!examCode) {
                alert('Por favor, ingresa un código de examen válido');
                return;
            }
            
            // Mostrar el indicador de carga
            toggleLoading(true);
            
            // Cargar el examen desde Firestore
            db.collection('exams').doc(examCode).get()
                .then((doc) => {
                    // Ocultar el indicador de carga
                    toggleLoading(false);
                    
                    if (!doc.exists) {
                        alert('No se encontró el examen con el código proporcionado');
                        return;
                    }
                    
                    const exam = doc.data();
                    document.getElementById('exam-title-display').textContent = exam.title;
                    
                    const questionsContainer = document.getElementById('exam-questions');
                    questionsContainer.innerHTML = '';
                    
                    exam.questions.forEach((question, index) => {
                        let questionHTML = `
                            <div class="question-container">
                                <p><strong>Pregunta ${index + 1}:</strong> ${question.text}</p>
                        `;
                        
                        if (question.type === 'text') {
                            questionHTML += `
                                <textarea class="answer-text" data-question="${index}" placeholder="Escribe tu respuesta aquí"></textarea>
                            `;
                        } else {
                            questionHTML += `<div class="options-container">`;
                            question.options.forEach((option, optIndex) => {
                                questionHTML += `
                                    <div class="option-item">
                                        <input type="radio" name="q${index}" value="${optIndex}" id="q${index}opt${optIndex}">
                                        <label for="q${index}opt${optIndex}">${option.text}</label>
                                    </div>
                                `;
                            });
                            questionHTML += `</div>`;
                        }
                        
                        questionHTML += `</div>`;
                        questionsContainer.insertAdjacentHTML('beforeend', questionHTML);
                    });
                    
                    document.getElementById('exam-info').style.display = 'none';
                    document.getElementById('exam-content').style.display = 'block';
                    
                    // Guardar el código del examen actual
                    examId = examCode;
                })
                .catch((error) => {
                    toggleLoading(false);
                    console.error("Error al cargar el examen: ", error);
                    alert('Error al cargar el examen: ' + error.message);
                });
        }
        
        // Cargar examen en modo solo examen
        function loadExamOnly(examCode) {
            if (!examCode) {
                alert('No se encontró el código del examen en la URL');
                return;
            }
            
            // Mostrar el indicador de carga
            toggleLoading(true);
            
            // Cargar el examen desde Firestore
            db.collection('exams').doc(examCode).get()
                .then((doc) => {
                    // Ocultar el indicador de carga
                    toggleLoading(false);
                    
                    if (!doc.exists) {
                        alert('No se encontró el examen con el código proporcionado');
                        return;
                    }
                    
                    const exam = doc.data();
                    document.getElementById('exam-only-title').textContent = exam.title;
                    
                    const questionsContainer = document.getElementById('exam-only-questions');
                    questionsContainer.innerHTML = '';
                    
                    exam.questions.forEach((question, index) => {
                        let questionHTML = `
                            <div class="question-container">
                                <p><strong>Pregunta ${index + 1}:</strong> ${question.text}</p>
                        `;
                        
                        if (question.type === 'text') {
                            questionHTML += `
                                <textarea class="answer-text" data-question="${index}" placeholder="Escribe tu respuesta aquí"></textarea>
                            `;
                        } else {
                            questionHTML += `<div class="options-container">`;
                            question.options.forEach((option, optIndex) => {
                                questionHTML += `
                                    <div class="option-item">
                                        <input type="radio" name="q${index}" value="${optIndex}" id="only_q${index}opt${optIndex}">
                                        <label for="only_q${index}opt${optIndex}">${option.text}</label>
                                    </div>
                                `;
                            });
                            questionHTML += `</div>`;
                        }
                        
                        questionHTML += `</div>`;
                        questionsContainer.insertAdjacentHTML('beforeend', questionHTML);
                    });
                    
                    document.getElementById('full-app').style.display = 'none';
                    document.getElementById('exam-only-view').style.display = 'block';
                    
                    // Guardar el código del examen actual
                    examId = examCode;
                })
                .catch((error) => {
                    toggleLoading(false);
                    console.error("Error al cargar el examen: ", error);
                    alert('Error al cargar el examen: ' + error.message);
                });
        }
        
        // Enviar respuestas (normal)
        function submitAnswers() {
            submitExamResponses();
            
            // Resetear la vista
            document.getElementById('exam-info').style.display = 'block';
            document.getElementById('exam-content').style.display = 'none';
            document.getElementById('exam-questions').innerHTML = '';
            document.getElementById('exam-code').value = '';
        }
        
        // Enviar respuestas (modo solo examen)
        function submitAnswersExamOnly() {
            submitExamResponses();
            
            // Mostrar mensaje de agradecimiento
            document.getElementById('exam-only-view').innerHTML = `
                <div class="question-container" style="text-align: center;">
                    <h2>¡Gracias por enviar tus respuestas!</h2>
                    <p>Tus respuestas han sido registradas correctamente.</p>
                </div>
            `;
        }
        
        // Función común para enviar respuestas
        function submitExamResponses() {
            if (!examId) {
                alert('Error: No se ha cargado correctamente el examen');
                return;
            }
            
            // Mostrar el indicador de carga
            toggleLoading(true);
            
            // Obtener el examen actual desde Firestore
            db.collection('exams').doc(examId).get()
                .then((doc) => {
                    if (!doc.exists) {
                        toggleLoading(false);
                        alert('Error: No se pudo encontrar la información del examen');
                        return;
                    }
                    
                    const exam = doc.data();
                    const isExamOnly = document.getElementById('full-app').style.display === 'none';
                    const questionsContainer = isExamOnly ? 
                                            document.getElementById('exam-only-questions') :
                                            document.getElementById('exam-questions');
                    
                    const answers = [];
                    
                    exam.questions.forEach((question, index) => {
                        let userAnswer = '';
                        
                        if (question.type === 'text') {
                            const textArea = questionsContainer.querySelector(`.answer-text[data-question="${index}"]`);
                            userAnswer = textArea ? textArea.value : '';
                        } else {
                            const radioName = `q${index}`;
                            const selectedOption = questionsContainer.querySelector(`input[name="${radioName}"]:checked`);
                            if (selectedOption) {
                                const optionIndex = parseInt(selectedOption.value);
                                userAnswer = question.options[optionIndex].text;
                            }
                        }
                        
                        answers.push({
                            question: question.text,
                            userAnswer: userAnswer,
                            correctAnswer: question.correctAnswer,
                            isCorrect: userAnswer.toLowerCase() === question.correctAnswer.toLowerCase()
                        });
                    });
                    
                    const response = {
                        id: 'resp_' + Date.now(),
                        timestamp: new Date().toISOString(),
                        answers: answers
                    };
                    
                    // Añadir la respuesta al array de respuestas del examen
                    const responses = exam.responses || [];
                    responses.push(response);
                    
                    // Actualizar el documento en Firestore
                    return db.collection('exams').doc(examId).update({
                        responses: responses
                    });
                })
                .then(() => {
                    // Ocultar el indicador de carga
                    toggleLoading(false);
                    alert('Respuestas enviadas correctamente');
                })
                .catch((error) => {
                    toggleLoading(false);
                    console.error("Error al enviar respuestas: ", error);
                    alert('Error al enviar respuestas: ' + error.message);
                });
        }
        
        // Cargar resultados
        function loadResults() {
            const codeInput = document.getElementById('results-code').value;
            const examCode = codeInput.includes('exam=') ? 
                            codeInput.split('exam=')[1].split('&')[0] :
                            codeInput;
            
            if (!examCode) {
                alert('Por favor, ingresa un código de examen válido');
                return;
            }
            
            // Mostrar el indicador de carga
            toggleLoading(true);
            
            // Cargar el examen desde Firestore
            db.collection('exams').doc(examCode).get()
                .then((doc) => {
                    // Ocultar el indicador de carga
                    toggleLoading(false);
                    
                    if (!doc.exists) {
                        alert('No se encontró el examen con el código proporcionado');
                        return;
                    }
                    
                    const exam = doc.data();
                    const responsesList = document.getElementById('responses-list');
                    responsesList.innerHTML = '';
                    
                    if (!exam.responses || exam.responses.length === 0) {
                        responsesList.innerHTML = '<p>Aún no hay respuestas para este examen</p>';
                    } else {
                        exam.responses.forEach((response, respIndex) => {
                            let correctCount = 0;
                            response.answers.forEach(answer => {
                                if (answer.isCorrect) correctCount++;
                            });
                            
                            const percentage = Math.round((correctCount / response.answers.length) * 100);
                            
                            let responseHTML = `
                                <div class="response-item">
                                    <h4>Respuesta #${respIndex + 1} - ${new Date(response.timestamp).toLocaleString()}</h4>
                                    <p>Puntuación: ${correctCount}/${response.answers.length} (${percentage}%)</p>
                                    <details>
                                        <summary>Ver detalles</summary>
                                        <div class="response-details">
                            `;
                            
                            response.answers.forEach((answer, ansIndex) => {
                                const status = answer.isCorrect ? 
                                            'correcto' : 
                                            'incorrecto';
                                const color = answer.isCorrect ? 
                                            'green' : 
                                            'red';
                                            
                                responseHTML += `
                                    <div style="margin-top: 10px; border-left: 3px solid ${color}; padding-left: 10px;">
                                        <p><strong>Pregunta ${ansIndex + 1}:</strong> ${answer.question}</p>
                                        <p><strong>Respuesta:</strong> ${answer.userAnswer}</p>
                                `;
                                
                                if (answer.correctAnswer) {
                                    responseHTML += `<p><strong>Respuesta correcta:</strong> ${answer.correctAnswer}</p>`;
                                }
                                
                                responseHTML += `
                                        <p><strong>Estado:</strong> <span style="color: ${color}">${status}</span></p>
                                    </div>
                                `;
                            });
                            
                            responseHTML += `
                                        </div>
                                    </details>
                                </div>
                            `;
                            
                            responsesList.insertAdjacentHTML('beforeend', responseHTML);
                        });
                    }
                    
                    document.getElementById('results-container').style.display = 'block';
                })
                .catch((error) => {
                    toggleLoading(false);
                    console.error("Error al cargar los resultados: ", error);
                    alert('Error al cargar los resultados: ' + error.message);
                });
        }
        
        // Verificar si hay un código de examen en la URL
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const examParam = urlParams.get('exam');
            const modeParam = urlParams.get('mode');
            
            if (examParam) {
                if (modeParam === 'only') {
                    // Modo solo examen
                    loadExamOnly(examParam);
                } else {
                    // Modo normal
                    document.getElementById('exam-code').value = examParam;
                    openTab({currentTarget: document.querySelector('.tablinks:nth-child(2)')}, 'responder');
